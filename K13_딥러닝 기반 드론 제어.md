# pyaidrone 기반 장애물 감지 및 회피 시스템

이 프로젝트는 라즈베리파이 Zero 2W와 카메라 모듈을 사용하여 미니 드론이 실시간으로 장애물을 감지하고 회피할 수 있는 시스템을 구현합니다. pyaidrone 라이브러리를 기반으로 8520 DC 모터를 제어하며, TensorFlow Lite 모델을 활용한 객체 인식 기능을 제공합니다.

## 기능

- 실시간 장애물 감지 및 자동 회피
- 수동 및 자동 모드 전환 가능
- 라즈베리파이 Zero 2W에 최적화된 경량 구현
- 키보드 기본 제어(이륙, 착륙, 고도 조절) 유지
- 시각화 옵션(카메라 화면과 감지 결과 실시간 표시)

## 하드웨어 요구사항

- 라즈베리파이 Zero 2W
- 라즈베리파이 카메라 모듈
- 8520 DC 모터가 장착된 미니 드론
- 호환되는 비행 컨트롤러
- 드론-라즈베리파이 연결 케이블

## 소프트웨어 요구사항

- 라즈베리파이 OS
- Python 3.7+
- pyaidrone 라이브러리
- TensorFlow Lite Runtime
- OpenCV
- Picamera2

## 설치 방법

1. 필요한 패키지 설치:

```bash
# 시스템 패키지 업데이트
sudo apt update
sudo apt upgrade -y

# 의존성 설치
sudo apt install -y python3-pip python3-opencv libjpeg-dev libopenjp2-7-dev

# Python 패키지 설치
pip3 install opencv-python-headless tflite-runtime picamera2

# pyaidrone 라이브러리 설치 (드론 제조사 제공 방법에 따라 설치)
```

2. 저장소 복제 및 설정:

```bash
# 저장소 복제
git clone https://github.com/yourusername/pyaidrone-obstacle-detection.git
cd pyaidrone-obstacle-detection

# 모델 다운로드 스크립트 실행 권한 부여
chmod +x download_model.sh

# 모델 다운로드
./download_model.sh
```

## 사용 방법

### 기본 사용법:

```bash
# 자동 장애물 회피 모드
python3 obstacle_avoidance.py

# 시각화 활성화
python3 obstacle_avoidance.py --visualize

# 감지 신뢰도 임계값 조정
python3 obstacle_avoidance.py --threshold 0.7

# 수동 제어 모드
python3 obstacle_avoidance.py --manual
```

### 키보드 단축키:

**자동 및 수동 모드 공통:**
- `Enter` - 이륙
- `Space` - 착륙
- `ESC` - 프로그램 종료
- `W` - 고도 증가
- `X` - 고도 감소

**수동 모드 추가 단축키:**
- `↑` - 전진
- `↓` - 후진
- `→` - 오른쪽 이동
- `←` - 왼쪽 이동
- `A` - 왼쪽으로 회전
- `D` - 오른쪽으로 회전

## 시스템 구성

### 파일 구조:

- `obstacle_avoidance.py` - 메인 프로그램
- `download_model.sh` - 모델 및 라벨 다운로드 스크립트
- `models/` - TensorFlow Lite 모델 및 라벨 저장 디렉토리

### 클래스 및 기능:

1. **ObstacleAvoidanceSystem** - 장애물 감지 및 회피 로직 구현:
   - `detect_obstacles()` - 카메라 이미지에서 장애물 감지
   - `calculate_avoidance_direction()` - 장애물 위치 분석 및 회피 방향 결정
   - `apply_avoidance_control()` - 드론에 회피 명령 전송
   - `visualize_detection()` - 장애물 감지 결과 시각화

2. **키보드 제어 함수:**
   - `manual_control()` - 수동 모드에서의 키보드 제어
   - `keyboard_control()` - 자동 모드에서의 기본 키보드 제어 (이륙/착륙)

## 프로그램 작동 원리

### 자동 회피 모드:

1. 카메라로 이미지 캡처
2. TensorFlow Lite 모델로 장애물 감지
3. 장애물 위치에 따른 회피 방향 계산
   - 왼쪽에 장애물 → 오른쪽으로 이동
   - 오른쪽에 장애물 → 왼쪽으로 이동
   - 직전에 장애물 → 위로 이동 또는 회전
4. 최적의 회피 명령을 드론에 전송

### 제어 안정화 기법:

- 방향 히스토리 유지로 급격한 방향 전환 방지
- 제어 명령 간 최소 시간 간격 설정
- 장애물 크기 가중치를 적용한 위협 수준 계산

## 커스터마이징

다음 부분을 수정하여 시스템을 맞춤 설정할 수 있습니다:

1. **연결 포트 변경:**
   ```python
   aidrone.Open("COM3")  # 라즈베리파이에서는 일반적으로 "/dev/ttyUSB0"
   ```

2. **감지 임계값 및 제어 간격 조정:**
   ```python
   self.threshold = 0.5  # 감지 신뢰도 임계값 (0.0~1.0)
   self.control_interval = 0.5  # 제어 명령 간 최소 간격(초)
   ```

3. **회피 속도 및 방향 조정:**
   ```python
   self.aidrone.velocity(LEFT, 50)  # 회피 이동 속도
   ```

4. **카메라 해상도 변경:**
   ```python
   config = self.camera.create_preview_configuration(main={"size": (320, 240)})
   ```

## 성능 최적화 팁

1. **모델 경량화**:
   - 더 작은 TensorFlow Lite 모델 사용
   - int8 양자화 모델 활용

2. **카메라 설정**:
   - 해상도 낮추기 (240p 또는 더 낮게)
   - 프레임 레이트 제한

3. **처리 빈도 조정**:
   - 모든 프레임을 처리하지 않고 몇 개의 프레임마다 처리

4. **배터리 최적화**:
   - 불필요한 시각화 비활성화
   - 프로세서 사용량 모니터링

## 문제 해결

- **드론 연결 문제**: 올바른 포트 설정 확인 (`COM3` 대신 `/dev/serial0` 등)
- **카메라 오류**: `picamera2` 라이브러리 설치 확인 및 카메라 모듈 연결 상태 점검
- **TFLite 오류**: 올바른 모델 파일 다운로드 확인
- **인식 오류**: 조명 조건 개선 및 임계값 조정
- **제어 지연**: 처리 주기 늘리기
